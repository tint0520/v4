<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tint Maps DEMO</title>
<!-- ğŸ”½ ä½ æŠŠé€™æ®µè²¼åœ¨é€™è£¡ ğŸ”½ -->

<!-- Favicon èˆ‡ PWA App Icon è¨­å®š -->
<link rel="manifest" href="./manifest.json" />
<link rel="apple-touch-icon" href="./img/icon_192.png" />
<link rel="icon" href="./img/icon_192.png" sizes="192x192" />
<link rel="icon" href="./img/icon_512.png" sizes="512x512" />
<meta name="theme-color" content="#ffffff" />

<!-- ğŸ”¼ ä¸Šé¢è²¼å®Œä¹‹å¾Œç¹¼çºŒæ¥è‘—ä¸‹é¢é€™è¡Œ ğŸ”¼ -->
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans TC', sans-serif;
      height: 100%;
      overflow: hidden;
      background-color: #fefcf9;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
      z-index: 1;
    }
    .bottom-nav {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #F8F0E2;
  border-radius: 20px;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
  display: flex;
  gap: 28px;
  padding: 10px 20px;
  z-index: 1000;
}
.nav-btn {
  background: none;
  border: none;
  padding: 6px;
  border-radius: 50%;
  transition: background 0.3s ease;
}
/* .nav-btn:hover {
  background: rgba(0, 0, 0, 0.04);
} */

  .card-container {
  position: absolute;
  bottom: 100px;
  left: 0;
  right: 0;
  z-index: 5;
  overflow-x: auto; /* âœ… æ”¹ç‚ºè®“æ•´å€‹å€å¡Šå¯æ©«å‘æ»‘å‹• */
  -webkit-overflow-scrolling: touch;
  pointer-events: all;
}

.card-wrapper {
  display: flex;
  gap: 12px;
  padding: 0 20px;
  min-width: max-content; /* âœ… è‡ªå‹•æ’é–‹å¯¬åº¦ä»¥å®¹ç´æ‰€æœ‰å¡ç‰‡ */
  scroll-snap-type: x mandatory;
}

.store-card {
  flex: 0 0 auto; /* âœ… ç¢ºä¿æ¯å¼µå¡ç‰‡ä¸è¢«å£“ç¸® */
  width: 280px;
  scroll-snap-align: center;
  background: #fffdf9;
  border-radius: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  padding: 16px;
  transition: transform 0.3s ease;
  cursor: pointer;
}
    .card-photo {
  width: 100%;
  height: 160px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 10px;
}
    .store-card .title {
  font-weight: 700;
  font-size: 18px; /* âœ… åŠ å¤§ä¸€éš */
  margin-bottom: 6px;
  color: #3e2e26; /* âœ… å¯é¸ï¼šè®“é¡è‰²å†æ·±ä¸€é»é» */
}
    .store-card .info {
      font-size: 14px;
      color: #7d756c;
    }
   .floating-window {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(100%);
  background: #ffffff;
  width: 300px; /* âœ… æ”¹æˆå›ºå®šå¯¬åº¦èˆ‡é¸å–®ä¸€è‡´ */
  border-radius: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.12);
  padding: 20px;
  z-index: 20;
  opacity: 0;
  transition: transform 0.3s ease, opacity 0.3s ease;
}
    .floating-window.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .floating-window .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 18px;
      color: #999;
      cursor: pointer;
    }

    /* Scroll bar hidden for webkit */
    .card-wrapper::-webkit-scrollbar {
      display: none;
    }

/* âœ… æ–°å¢ GPS å®šä½æŒ‰éˆ•æ¨£å¼ */
.gps-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 48px;
  height: 48px;
  background: #ffffff;
  border: none;
  border-radius: 50%;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  padding: 6px; /* ä½ å¯ä»¥èª¿æ•´é€™å€‹ä¾†è®“ icon ä¸å¤ªè²¼é‚Š */
  z-index: 999;
  cursor: pointer;
  transition: background 0.3s ease;
}

.gps-btn:hover {
  background: #f2f2f2;
}

.gps-icon {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}
    
  </style>
</head>
<body>
  <div id="map"></div>
<button class="gps-btn" onclick="centerOnGPS()" title="å®šä½åˆ°æˆ‘">
  <img src="./img/icon_gps.png" class="gps-icon" alt="å®šä½" />
</button>

    <!-- åº—å®¶å¡ç‰‡æ»‘å‹•å®¹å™¨ -->
  <div class="card-container">
    <div class="card-wrapper" id="cardWrapper">
      <!-- JSæœƒå‹•æ…‹æ’å…¥å¡ç‰‡ -->
    </div>
  </div>

  <!-- æµ®çª—å€å¡Šï¼šæœå°‹ / æ”¶è— / é¸å–® -->
  <div id="searchWindow" class="floating-window">
    <button class="close-btn" onclick="closeWindow('searchWindow')">Ã—</button>
    <h3>æœå°‹èˆ‡ç¯©é¸</h3>
    <input type="text" placeholder="æœå°‹åœ°å€ã€é—œéµå­—..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin:12px 0;" />
    <p style="font-size:14px;color:#666;">å¯ç¯©é¸ï¼šåœ°å€ / é¡å‹ / é ç´„æ–¹å¼</p>
  </div>
  <div id="favoriteWindow" class="floating-window">
    <button class="close-btn" onclick="closeWindow('favoriteWindow')">Ã—</button>
    <h3>æ”¶è—æ¸…å–®</h3>
    <p>å°šç„¡æ”¶è—çš„åº—å®¶</p>
  </div>
  <div id="menuWindow" class="floating-window">
    <button class="close-btn" onclick="closeWindow('menuWindow')">Ã—</button>
    <h3>æ›´å¤šé¸é …</h3>
    <p>åŠŸèƒ½å»ºç½®ä¸­</p>
  </div>

  <!-- åº•éƒ¨é¸å–® -->
 <div class="bottom-nav">
  <!-- ğŸ” æœå°‹ -->
  <button class="nav-btn" onclick="toggleWindow('searchWindow')">
    <img src="./img/icon_search.png" alt="æœå°‹" width="30" height="30" />
  </button>

  <!-- ğŸ§Š ç¯©é¸ -->
  <button class="nav-btn" onclick="toggleWindow('filterWindow')">
    <img src="./img/icon_filter.png" alt="ç¯©é¸" width="30" height="30" />
  </button>

  <!-- ğŸ  é¦–é  -->
  <button class="nav-btn" onclick="closeExpandedCard()">
    <img src="./img/icon_home.png" alt="é¦–é " width="30" height="30" />
  </button>

  <!-- â¤ï¸ æ”¶è— -->
  <button class="nav-btn" onclick="toggleWindow('favoriteWindow')">
    <img src="./img/icon_heart.png" alt="æ”¶è—" width="30" height="30" />
  </button>

  <!-- â˜° æ¼¢å ¡é¸å–® -->
  <button class="nav-btn" onclick="toggleWindow('menuWindow')">
    <img src="./img/icon_menu.png" alt="é¸å–®" width="30" height="30" />
  </button>
</div>

  <!-- Google Maps JS + å‡è³‡æ–™èˆ‡äº’å‹•é‚è¼¯ -->
  <script>
const SHEET_ID = "14t6vKkQjk4iIITUIIMRUH6wN5pyOEPJt8bIxlEkkkow";
const SHEET_NAME = "å·¥ä½œè¡¨1";
const SHEET_URL = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;

let map, userMarker, activeIndex = 0;
let stores = []; // âœ… çœŸè³‡æ–™æœƒå¾ fetch é€²ä¾†
const markers = []; // âœ… markers è¦æ”¾åœ¨ fetch å¤–ï¼Œæˆç‚ºå…¨åŸŸè®Šæ•¸

navigator.geolocation.getCurrentPosition(pos => {
  const userLat = pos.coords.latitude;
  const userLng = pos.coords.longitude;

  fetch(SHEET_URL)
    .then(res => res.json())
    .then(data => {
      stores = data.map(row => {
        const distanceMeters = getDistance(
          userLat, userLng,
          parseFloat(row.lat), parseFloat(row.lng)
        );

        const distanceText = distanceMeters < 1000
          ? `${Math.round(distanceMeters)}m`
          : `${(distanceMeters / 1000).toFixed(1)}km`;

        return {
          name: row.name,
          lat: parseFloat(row.lat),
          lng: parseFloat(row.lng),
          image: row.image,
          time: row.time,
          services: row.services,
          reservation: row.reservation,
          region: row.region,
          distance: distanceText
        };
      });

      initMap({ lat: userLat, lng: userLng }); // âœ… æ”¾é€™é‚Šæ²’éŒ¯
    }); // âœ… è£œé½Š fetch çš„æ‹¬è™Ÿ
});
  

    function initMap(userPos) {
        map = new google.maps.Map(document.getElementById('map'), {
          center: userPos, zoom: 14,
          mapTypeControl: false  // âœ… é—œé–‰å³ä¸Šè§’åœ–å±¤æ§åˆ¶ï¼ˆåœ°åœ–/è¡›æ˜Ÿï¼‰
        });
        userMarker = new google.maps.Marker({
          position: userPos,
          map: map,
          title: 'ä½ åœ¨é€™è£¡',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#4285F4',
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: '#fff'
          }
        });
        stores.forEach((store, index) => {
          const marker = new google.maps.Marker({
            position: { lat: store.lat, lng: store.lng },
            map: map,
            title: store.name
          });
          markers.push(marker);
        });
        renderCards();
        updateCardUI(0);
        // ğŸ” æ»‘å‹•å¡ç‰‡æ™‚è‡ªå‹•åµæ¸¬å°æ‡‰å¡ç‰‡ï¼Œä¸¦æ›´æ–°åœ°åœ–ä¸­å¿ƒèˆ‡è³‡æ–™
document.getElementById('cardWrapper').addEventListener('scroll', function () {
  const wrapper = this;
  const cards = wrapper.querySelectorAll('.store-card');
  let minDistance = Infinity;
  let closestIndex = 0;

  cards.forEach((card, index) => {
    const cardCenter = card.getBoundingClientRect().left + card.offsetWidth / 2;
    const wrapperCenter = wrapper.getBoundingClientRect().left + wrapper.offsetWidth / 2;
    const distance = Math.abs(cardCenter - wrapperCenter);
    if (distance < minDistance) {
      minDistance = distance;
      closestIndex = index;
    }
  });

  // è‹¥æ»‘å‹•åˆ°æ–°å¡ç‰‡å°±æ›´æ–°åœ°åœ–ä½ç½®
  if (closestIndex !== activeIndex) {
    updateCardUI(closestIndex, true);
  }
});
      });
    }

    function renderCards() {
      const wrapper = document.getElementById('cardWrapper');
      stores.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'store-card';
div.innerHTML = `
 <img src="${s.image}" class="card-photo" />
  <div class="title">${s.name}</div>
  <div class="info">æ™‚é–“ï¼š${s.time}</div>
  <div class="info">æœå‹™ï¼š${s.services}</div>
  <div class="info">é ç´„ï¼š${s.reservation}</div>
  <div class="info">è·é›¢ï¼š${s.distance}ãƒ»${s.region}</div>
`;
        div.onclick = () => updateCardUI(i, true);
        wrapper.appendChild(div);
      });
    }

function updateCardUI(index) {
  activeIndex = index;
  const s = stores[index];

  // å…ˆç§»å‹•åœ°åœ–åˆ°è©²åº—å®¶ä½ç½®
  map.setCenter({ lat: s.lat, lng: s.lng });

  // å†ç”¨ panBy æŠŠç•«é¢å¾€ä¸‹æ»‘ 1/3ï¼Œè®“ç´…é»é¡¯ç¤ºåœ¨ç•«é¢ä¸Šæ–¹
  google.maps.event.addListenerOnce(map, 'idle', function () {
    const mapHeight = document.getElementById("map").offsetHeight;
    map.panBy(0, mapHeight / 3);
  });
}

   function toggleWindow(id) {
  const target = document.getElementById(id);
  const isOpen = target.classList.contains('active');

  // å¦‚æœåŸæœ¬æ²’é–‹ï¼Œå°±é–‹ï¼›å·²é–‹å°±æ”¶èµ·
  if (!isOpen) {
    target.classList.add('active');
  }
}

    function closeWindow(id) {
      document.getElementById(id).classList.remove('active');
    }

function centerOnGPS() {
  if (navigator.geolocation && map) {
    navigator.geolocation.getCurrentPosition(pos => {
      const userPos = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };
      map.setCenter(userPos);
      google.maps.event.addListenerOnce(map, 'idle', function () {
        const mapHeight = document.getElementById("map").offsetHeight;
        map.panBy(0, mapHeight / 3);
      });
    });
  }
}
    // DEBUG: å¼·åˆ¶å±•é–‹ç¬¬ä¸€ç­†å¡ç‰‡ä¾†ç¢ºèªå±•é–‹å¡ç‰‡æ˜¯å¦æœ‰ä½œç”¨
window.addEventListener('load', () => {
  setTimeout(() => {
    updateCardUI(0);
  }, 1000);
});

  function getDistance(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}  
</script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLCB3EKFwsIqPwEEL_hxL7zluVpnzcCNM&callback=initMap"></script>
</body>
</html>
