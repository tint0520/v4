<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tint Maps DEMO</title>
<!-- 🔽 你把這段貼在這裡 🔽 -->

<!-- Favicon 與 PWA App Icon 設定 -->
<link rel="manifest" href="./manifest.json" />
<link rel="apple-touch-icon" href="./img/icon_192.png" />
<link rel="icon" href="./img/icon_192.png" sizes="192x192" />
<link rel="icon" href="./img/icon_512.png" sizes="512x512" />
<meta name="theme-color" content="#ffffff" />

<!-- 🔼 上面貼完之後繼續接著下面這行 🔼 -->
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans TC', sans-serif;
      height: 100%;
      overflow: hidden;
      background-color: #fefcf9;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
      z-index: 1;
    }
    .bottom-nav {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #F8F0E2;
  border-radius: 20px;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
  display: flex;
  gap: 28px;
  padding: 10px 20px;
  z-index: 1000;
}
.nav-btn {
  background: none;
  border: none;
  padding: 6px;
  border-radius: 50%;
  transition: background 0.3s ease;
}
/* .nav-btn:hover {
  background: rgba(0, 0, 0, 0.04);
} */

  .card-container {
  position: absolute;
  bottom: 100px;
  left: 0;
  right: 0;
  z-index: 5;
  overflow-x: auto; /* ✅ 改為讓整個區塊可橫向滑動 */
  -webkit-overflow-scrolling: touch;
  pointer-events: all;
}

.card-wrapper {
  display: flex;
  gap: 12px;
  padding: 0 20px;
  min-width: max-content; /* ✅ 自動撐開寬度以容納所有卡片 */
  scroll-snap-type: x mandatory;
}

.store-card {
  flex: 0 0 auto; /* ✅ 確保每張卡片不被壓縮 */
  width: 280px;
  scroll-snap-align: center;
  background: #fffdf9;
  border-radius: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  padding: 16px;
  transition: transform 0.3s ease;
  cursor: pointer;
}
    .card-photo {
  width: 100%;
  height: 160px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 10px;
}
    .store-card .title {
  font-weight: 700;
  font-size: 18px; /* ✅ 加大一階 */
  margin-bottom: 6px;
  color: #3e2e26; /* ✅ 可選：讓顏色再深一點點 */
}
    .store-card .info {
      font-size: 14px;
      color: #7d756c;
    }
   .floating-window {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(100%);
  background: #ffffff;
  width: 300px; /* ✅ 改成固定寬度與選單一致 */
  border-radius: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.12);
  padding: 20px;
  z-index: 20;
  opacity: 0;
  transition: transform 0.3s ease, opacity 0.3s ease;
}
    .floating-window.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .floating-window .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 18px;
      color: #999;
      cursor: pointer;
    }

    /* Scroll bar hidden for webkit */
    .card-wrapper::-webkit-scrollbar {
      display: none;
    }

/* ✅ 新增 GPS 定位按鈕樣式 */
.gps-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 48px;
  height: 48px;
  background: #ffffff;
  border: none;
  border-radius: 50%;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  padding: 6px; /* 你可以調整這個來讓 icon 不太貼邊 */
  z-index: 999;
  cursor: pointer;
  transition: background 0.3s ease;
}

.gps-btn:hover {
  background: #f2f2f2;
}

.gps-icon {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}
    
  </style>
</head>
<body>
  <div id="map"></div>
<button class="gps-btn" onclick="centerOnGPS()" title="定位到我">
  <img src="./img/icon_gps.png" class="gps-icon" alt="定位" />
</button>

    <!-- 店家卡片滑動容器 -->
  <div class="card-container">
    <div class="card-wrapper" id="cardWrapper">
      <!-- JS會動態插入卡片 -->
    </div>
  </div>

  <!-- 浮窗區塊：搜尋 / 收藏 / 選單 -->
  <div id="searchWindow" class="floating-window">
    <button class="close-btn" onclick="closeWindow('searchWindow')">×</button>
    <h3>搜尋與篩選</h3>
    <input type="text" placeholder="搜尋地區、關鍵字..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin:12px 0;" />
    <p style="font-size:14px;color:#666;">可篩選：地區 / 類型 / 預約方式</p>
  </div>
  <div id="favoriteWindow" class="floating-window">
    <button class="close-btn" onclick="closeWindow('favoriteWindow')">×</button>
    <h3>收藏清單</h3>
    <p>尚無收藏的店家</p>
  </div>
  <div id="menuWindow" class="floating-window">
    <button class="close-btn" onclick="closeWindow('menuWindow')">×</button>
    <h3>更多選項</h3>
    <p>功能建置中</p>
  </div>

  <!-- 底部選單 -->
 <div class="bottom-nav">
  <!-- 🔍 搜尋 -->
  <button class="nav-btn" onclick="toggleWindow('searchWindow')">
    <img src="./img/icon_search.png" alt="搜尋" width="30" height="30" />
  </button>

  <!-- 🧊 篩選 -->
  <button class="nav-btn" onclick="toggleWindow('filterWindow')">
    <img src="./img/icon_filter.png" alt="篩選" width="30" height="30" />
  </button>

  <!-- 🏠 首頁 -->
  <button class="nav-btn" onclick="closeExpandedCard()">
    <img src="./img/icon_home.png" alt="首頁" width="30" height="30" />
  </button>

  <!-- ❤️ 收藏 -->
  <button class="nav-btn" onclick="toggleWindow('favoriteWindow')">
    <img src="./img/icon_heart.png" alt="收藏" width="30" height="30" />
  </button>

  <!-- ☰ 漢堡選單 -->
  <button class="nav-btn" onclick="toggleWindow('menuWindow')">
    <img src="./img/icon_menu.png" alt="選單" width="30" height="30" />
  </button>
</div>

  <!-- Google Maps JS + 假資料與互動邏輯 -->
  <script>
const SHEET_ID = "14t6vKkQjk4iIITUIIMRUH6wN5pyOEPJt8bIxlEkkkow";
const SHEET_NAME = "工作表1";
const SHEET_URL = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;

let map, userMarker, activeIndex = 0;
let stores = []; // ✅ 真資料會從 fetch 進來
const markers = []; // ✅ markers 要放在 fetch 外，成為全域變數

navigator.geolocation.getCurrentPosition(pos => {
  const userLat = pos.coords.latitude;
  const userLng = pos.coords.longitude;

  fetch(SHEET_URL)
    .then(res => res.json())
    .then(data => {
      stores = data.map(row => {
        const distanceMeters = getDistance(
          userLat, userLng,
          parseFloat(row.lat), parseFloat(row.lng)
        );

        const distanceText = distanceMeters < 1000
          ? `${Math.round(distanceMeters)}m`
          : `${(distanceMeters / 1000).toFixed(1)}km`;

        return {
          name: row.name,
          lat: parseFloat(row.lat),
          lng: parseFloat(row.lng),
          image: row.image,
          time: row.time,
          services: row.services,
          reservation: row.reservation,
          region: row.region,
          distance: distanceText
        };
      });

      initMap({ lat: userLat, lng: userLng }); // ✅ 放這邊沒錯
    }); // ✅ 補齊 fetch 的括號
});
  

    function initMap(userPos) {
        map = new google.maps.Map(document.getElementById('map'), {
          center: userPos, zoom: 14,
          mapTypeControl: false  // ✅ 關閉右上角圖層控制（地圖/衛星）
        });
        userMarker = new google.maps.Marker({
          position: userPos,
          map: map,
          title: '你在這裡',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#4285F4',
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: '#fff'
          }
        });
        stores.forEach((store, index) => {
          const marker = new google.maps.Marker({
            position: { lat: store.lat, lng: store.lng },
            map: map,
            title: store.name
          });
          markers.push(marker);
        });
        renderCards();
        updateCardUI(0);
        // 🔁 滑動卡片時自動偵測對應卡片，並更新地圖中心與資料
document.getElementById('cardWrapper').addEventListener('scroll', function () {
  const wrapper = this;
  const cards = wrapper.querySelectorAll('.store-card');
  let minDistance = Infinity;
  let closestIndex = 0;

  cards.forEach((card, index) => {
    const cardCenter = card.getBoundingClientRect().left + card.offsetWidth / 2;
    const wrapperCenter = wrapper.getBoundingClientRect().left + wrapper.offsetWidth / 2;
    const distance = Math.abs(cardCenter - wrapperCenter);
    if (distance < minDistance) {
      minDistance = distance;
      closestIndex = index;
    }
  });

  // 若滑動到新卡片就更新地圖位置
  if (closestIndex !== activeIndex) {
    updateCardUI(closestIndex, true);
  }
});
      });
    }

    function renderCards() {
      const wrapper = document.getElementById('cardWrapper');
      stores.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'store-card';
div.innerHTML = `
 <img src="${s.image}" class="card-photo" />
  <div class="title">${s.name}</div>
  <div class="info">時間：${s.time}</div>
  <div class="info">服務：${s.services}</div>
  <div class="info">預約：${s.reservation}</div>
  <div class="info">距離：${s.distance}・${s.region}</div>
`;
        div.onclick = () => updateCardUI(i, true);
        wrapper.appendChild(div);
      });
    }

function updateCardUI(index) {
  activeIndex = index;
  const s = stores[index];

  // 先移動地圖到該店家位置
  map.setCenter({ lat: s.lat, lng: s.lng });

  // 再用 panBy 把畫面往下滑 1/3，讓紅點顯示在畫面上方
  google.maps.event.addListenerOnce(map, 'idle', function () {
    const mapHeight = document.getElementById("map").offsetHeight;
    map.panBy(0, mapHeight / 3);
  });
}

   function toggleWindow(id) {
  const target = document.getElementById(id);
  const isOpen = target.classList.contains('active');

  // 如果原本沒開，就開；已開就收起
  if (!isOpen) {
    target.classList.add('active');
  }
}

    function closeWindow(id) {
      document.getElementById(id).classList.remove('active');
    }

function centerOnGPS() {
  if (navigator.geolocation && map) {
    navigator.geolocation.getCurrentPosition(pos => {
      const userPos = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };
      map.setCenter(userPos);
      google.maps.event.addListenerOnce(map, 'idle', function () {
        const mapHeight = document.getElementById("map").offsetHeight;
        map.panBy(0, mapHeight / 3);
      });
    });
  }
}
    // DEBUG: 強制展開第一筆卡片來確認展開卡片是否有作用
window.addEventListener('load', () => {
  setTimeout(() => {
    updateCardUI(0);
  }, 1000);
});

  function getDistance(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}  
</script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLCB3EKFwsIqPwEEL_hxL7zluVpnzcCNM&callback=initMap"></script>
</body>
</html>
